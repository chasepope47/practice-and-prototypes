<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NetRunner Ops – Web Sim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --bg-alt: #0b1020;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
      --border: #1f2933;
      --card-bg: #070c1a;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.5);
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 24px;
    }

    .shell {
      width: 100%;
      max-width: 960px;
      background: linear-gradient(145deg, #020617, #030712);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 20px 24px 16px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .shell::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.12), transparent 55%),
                  radial-gradient(circle at 100% 100%, rgba(94, 234, 212, 0.12), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    .shell-inner {
      position: relative;
      z-index: 1;
    }

    .shell-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .shell-buttons {
      display: flex;
      gap: 6px;
    }

    .dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: #ef4444;
      box-shadow: 0 0 0 1px rgba(31, 41, 55, 0.8);
    }
    .dot.yellow {
      background: #facc15;
    }
    .dot.green {
      background: #22c55e;
    }

    .shell-title {
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .shell-indicators {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .indicator-pill {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .indicator-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }

    .layout {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 780px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .rooms {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .room-card {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(55, 65, 81, 0.8);
      padding: 10px 11px;
      cursor: pointer;
      transition: transform 0.12s ease, border-color 0.12s ease,
        box-shadow 0.12s ease, background 0.12s ease;
      position: relative;
      overflow: hidden;
    }

    .room-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.12), transparent 55%);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }

    .room-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.2),
        0 0 18px rgba(56, 189, 248, 0.25);
    }

    .room-card:hover {
      transform: translateY(-1px);
      border-color: rgba(148, 163, 184, 0.9);
    }

    .room-card.active::after {
      opacity: 1;
    }

    .room-title {
      font-size: 0.88rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .room-sub {
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .room-body {
      font-size: 0.75rem;
      color: #d1d5db;
      line-height: 1.35;
    }

    .room-shortcut {
      font-size: 0.7rem;
      margin-top: 6px;
      color: var(--muted);
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .console-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(55, 65, 81, 0.8);
      padding: 10px 11px 10px;
      display: flex;
      flex-direction: column;
      min-height: 340px;
      max-height: 540px;
    }

    .console-log {
      flex: 1;
      overflow-y: auto;
      padding: 8px 8px 8px 4px;
      scrollbar-width: thin;
      scrollbar-color: #4b5563 #020617;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .console-log::-webkit-scrollbar {
      width: 6px;
    }

    .console-log::-webkit-scrollbar-thumb {
      background: #374151;
      border-radius: 999px;
    }

    .console-line {
      margin-bottom: 4px;
    }

    .console-line.system {
      color: var(--muted);
    }

    .console-line.info {
      color: var(--accent);
    }

    .console-line.error {
      color: var(--danger);
    }

    .console-line.success {
      color: var(--success);
    }

    .console-line.cmd {
      color: #e5e7eb;
    }

    .console-line span.prompt {
      color: var(--accent);
    }

    .console-footer {
      margin-top: 8px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      padding-top: 6px;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .prompt-label {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      color: var(--accent);
      user-select: none;
    }

    .cmd-input {
      flex: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      color: var(--text);
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
        Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
    }

    .cmd-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.25);
      background: #020617;
    }

    .run-btn {
      padding: 5px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at 0 0, #1f2937, #020617);
      color: var(--text);
      font-size: 0.76rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: background 0.12s ease, transform 0.08s ease,
        border-color 0.12s ease, box-shadow 0.12s ease;
    }

    .run-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.35);
      transform: translateY(-0.5px);
    }

    .run-btn:active {
      transform: translateY(0.5px) scale(0.99);
      box-shadow: none;
    }

    .hint-row {
      margin-top: 5px;
      font-size: 0.72rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 1px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      font-size: 0.68rem;
    }

    .stat-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .stat-pill {
      font-size: 0.68rem;
      color: var(--muted);
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
    }

    .stat-pill strong {
      color: var(--accent);
      font-weight: 500;
    }

    .detection-pill {
      font-size: 0.68rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
    }

    .detection-pill span {
      color: var(--danger);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="shell-inner">
      <div class="shell-header">
        <div class="shell-buttons">
          <div class="dot"></div>
          <div class="dot yellow"></div>
          <div class="dot green"></div>
        </div>
        <div class="shell-title">NetRunner Ops · web-sim</div>
        <div class="shell-indicators">
          <div class="indicator-pill">
            <div class="indicator-dot"></div>
            <span>SIM ONLINE</span>
          </div>
          <span>v1.0</span>
        </div>
      </div>

      <div class="layout">
        <!-- Rooms / Sidebar -->
        <div class="rooms">
          <div class="room-card active" data-room="lobby">
            <div class="room-title">Lobby</div>
            <div class="room-sub">/room lobby</div>
            <div class="room-body">
              Welcome to the NetRunner Ops simulation. Type <code>help</code> to see basic commands,
              or <code>help roles</code> to learn about each operator type.
            </div>
            <div class="room-shortcut">Hint: start with <code>handle yourname</code></div>
          </div>

          <div class="room-card" data-room="roles">
            <div class="room-title">Role Hub</div>
            <div class="room-sub">/room roles</div>
            <div class="room-body">
              Inspect and pick your operator type:
              Brute Forcer, Social Engineer, or Analyst.
            </div>
            <div class="room-shortcut">Command: <code>role 1</code>, <code>role 2</code>, <code>role 3</code></div>
          </div>

          <div class="room-card" data-room="missions">
            <div class="room-title">Mission Control</div>
            <div class="room-sub">/room missions</div>
            <div class="room-body">
              Browse available contracts and select a mission to run in the sim.
            </div>
            <div class="room-shortcut">Command: <code>missions</code>, <code>mission 1</code></div>
          </div>

          <div class="room-card" data-room="ops">
            <div class="room-title">Ops Room</div>
            <div class="room-sub">/room ops</div>
            <div class="room-body">
              Act on the target: recon, scans, phishing, brute attacks, backdoors, and exfiltration.
            </div>
            <div class="room-shortcut">Examples: <code>recon</code>, <code>scan</code>, <code>exfiltrate</code></div>
          </div>
        </div>

        <!-- Console -->
        <div class="console-card">
          <div class="console-log" id="console-log"></div>
          <div class="console-footer">
            <div class="input-row">
              <span class="prompt-label">&gt;</span>
              <input
                id="cmd-input"
                class="cmd-input"
                autocomplete="off"
                spellcheck="false"
                placeholder='try "help" or "help roles"'
              />
              <button class="run-btn" id="run-btn">
                Run
              </button>
            </div>
            <div class="hint-row">
              <div>
                <span class="badge">Core: <code>handle</code>, <code>role</code>, <code>missions</code>, <code>recon</code>, <code>status</code></span>
              </div>
              <div class="stat-row" id="stat-row">
                <!-- filled by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============================== //
    //  CORE GAME STATE & UTILITIES   //
    // =============================== //

    const logEl = document.getElementById("console-log");
    const cmdInput = document.getElementById("cmd-input");
    const runBtn = document.getElementById("run-btn");
    const statRow = document.getElementById("stat-row");

    function log(text, type = "system") {
      const line = document.createElement("div");
      line.className = "console-line " + type;
      line.textContent = text;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function logCmd(text) {
      const line = document.createElement("div");
      line.className = "console-line cmd";
      line.innerHTML = '<span class="prompt">&gt;</span> ' + text;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function randomBetween(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    class Player {
      constructor() {
        this.handle = null;
        this.roleKey = null;
        this.role = null;
        this.stealth = 0;
        this.tech = 0;
        this.social = 0;
        this.xp = 0;
        this.credits = 0;
        this.level = 1;
        this.detection = 0;
        this.activeIntel = {
          recon: false,
          scan: false,
          credentialEdge: false,
          backdoor: false,
        };
      }

      setRole(roleKey) {
        const roles = {
          brute: {
            name: "Brute Forcer",
            stealth: 2,
            tech: 5,
            social: 2,
            description: "High-power, aggressive approaches with loud footprints.",
          },
          social: {
            name: "Social Engineer",
            stealth: 4,
            tech: 2,
            social: 5,
            description: "Manipulates people, not systems, in the sim.",
          },
          analyst: {
            name: "Analyst",
            stealth: 3,
            tech: 4,
            social: 3,
            description: "Balanced planner who excels at recon and strategy.",
          },
        };

        if (!roles[roleKey]) {
          throw new Error("Invalid role");
        }

        this.roleKey = roleKey;
        this.role = roles[roleKey];
        this.stealth = this.role.stealth;
        this.tech = this.role.tech;
        this.social = this.role.social;
      }

      addXP(amount) {
        this.xp += amount;
        const needed = this.level * 50;
        if (this.xp >= needed) {
          this.level++;
          this.xp -= needed;
          this.stealth++;
          this.tech++;
          this.social++;
          log("Level up! Your skills improve.", "success");
        }
      }

      addCredits(amount) {
        this.credits += amount;
      }

      adjustDetection(amount) {
        this.detection = Math.max(0, Math.min(100, this.detection + amount));
      }

      resetMissionState() {
        this.detection = 0;
        this.activeIntel = {
          recon: false,
          scan: false,
          credentialEdge: false,
          backdoor: false,
        };
      }
    }

    function createMissions() {
      return [
        {
          id: 1,
          name: "Local Startup Test",
          difficulty: 1,
          baseReward: 50,
          description:
            "A small startup wants a baseline security simulation. Low risk, good warm-up.",
        },
        {
          id: 2,
          name: "Regional Retail Audit",
          difficulty: 2,
          baseReward: 100,
          description:
            "Mid-sized retailer. Includes web, simple cloud, and credentials training.",
        },
        {
          id: 3,
          name: "Cloud Infrastructure Simulation",
          difficulty: 3,
          baseReward: 200,
          description:
            "Complex cloud-style simulation with multiple layers of defenses.",
        },
      ];
    }

    const game = {
      player: new Player(),
      missions: createMissions(),
      currentMission: null,
      inMission: false,
      currentRoom: "lobby",
    };

    function updateStatsRow() {
      statRow.innerHTML = "";

      const p = game.player;

      const handlePill = document.createElement("div");
      handlePill.className = "stat-pill";
      handlePill.innerHTML =
        "<strong>Handle:</strong> " + (p.handle || "<unset>");
      statRow.appendChild(handlePill);

      const rolePill = document.createElement("div");
      rolePill.className = "stat-pill";
      rolePill.innerHTML =
        "<strong>Role:</strong> " + (p.role ? p.role.name : "<unset>");
      statRow.appendChild(rolePill);

      const lvlPill = document.createElement("div");
      lvlPill.className = "stat-pill";
      lvlPill.innerHTML = "<strong>Lvl:</strong> " + p.level + " · " + p.xp + " XP";
      statRow.appendChild(lvlPill);

      const creditPill = document.createElement("div");
      creditPill.className = "stat-pill";
      creditPill.innerHTML = "<strong>Credits:</strong> " + p.credits;
      statRow.appendChild(creditPill);

      const detectPill = document.createElement("div");
      detectPill.className = "detection-pill";
      detectPill.innerHTML = "Detection: <span>" + p.detection + "/100</span>";
      statRow.appendChild(detectPill);
    }

    function setRoom(room) {
      game.currentRoom = room;
      document
        .querySelectorAll(".room-card")
        .forEach((card) => card.classList.remove("active"));
      const active = document.querySelector('.room-card[data-room="' + room + '"]');
      if (active) active.classList.add("active");
    }

    // ============================= //
    //       ACTION HANDLERS         //
    // ============================= //

    function requirePlayerSetup() {
      if (!game.player.handle) {
        log("You must set a handle first: handle yourname", "error");
        return false;
      }
      if (!game.player.role) {
        log("You must choose a role: role 1 | role 2 | role 3", "error");
        return false;
      }
      return true;
    }

    function showHelp(topic) {
      if (!topic) {
        log("Available commands:", "info");
        log("  help                   – show this help", "system");
        log("  help roles             – describe each role", "system");
        log("  handle <name>          – set your operator handle", "system");
        log("  role <1|2|3>           – pick a role (Brute, Social, Analyst)", "system");
        log("  missions               – list available missions", "system");
        log("  mission <id>           – start a mission", "system");
        log("  status                 – show your current stats", "system");
        log("  room <lobby|roles|missions|ops> – move focus between rooms", "system");
        log("  During missions:", "info");
        log("    recon, scan, phish, brute, backdoor, exfiltrate, abort", "system");
        return;
      }

      if (topic === "roles") {
        log("Role descriptions:", "info");
        log("  1) Brute Forcer", "system");
        log("     High TECH, lower STEALTH & SOCIAL.", "system");
        log("     Good at BRUTE and technical SCAN actions, riskier moves.", "system");
        log("  2) Social Engineer", "system");
        log("     High SOCIAL and STEALTH, lower TECH.", "system");
        log("     Excels at PHISH and subtle actions, less direct tech.", "system");
        log("  3) Analyst", "system");
        log("     Balanced STEALTH, TECH, SOCIAL.", "system");
        log("     Strong at RECON, SCAN, and strategic play.", "system");
      } else {
        log("Unknown help topic. Try: help or help roles", "error");
      }
    }

    function handleHandleCommand(args) {
      if (!args.length) {
        log("Usage: handle <name>", "error");
        return;
      }
      const name = args.join(" ");
      game.player.handle = name;
      log(`Handle set to "${name}".`, "success");
    }

    function handleRoleCommand(args) {
      if (!args.length) {
        log("Usage: role <1|2|3>", "error");
        return;
      }
      const raw = args[0];
      let key = null;
      if (raw === "1" || raw === "brute") key = "brute";
      if (raw === "2" || raw === "social") key = "social";
      if (raw === "3" || raw === "analyst") key = "analyst";

      if (!key) {
        log("Invalid role. Use: role 1, role 2, or role 3.", "error");
        return;
      }

      game.player.setRole(key);
      log(`Role set to ${game.player.role.name}.`, "success");
      log(game.player.role.description, "system");
    }

    function listMissions() {
      if (!requirePlayerSetup()) return;
      setRoom("missions");
      log("Available missions:", "info");
      for (const m of game.missions) {
        log(
          `  [${m.id}] ${m.name} · Diff ${m.difficulty}, Reward ${m.baseReward} credits`,
          "system"
        );
        log("      " + m.description, "system");
      }
    }

    function startMission(args) {
      if (!requirePlayerSetup()) return;
      if (!args.length) {
        log("Usage: mission <id>", "error");
        return;
      }
      const id = Number(args[0]);
      const mission = game.missions.find((m) => m.id === id);
      if (!mission) {
        log("No mission with that id. Use: missions", "error");
        return;
      }

      game.currentMission = mission;
      game.inMission = true;
      game.player.resetMissionState();
      setRoom("ops");

      log(`Starting mission: ${mission.name}`, "info");
      log(mission.description, "system");
      log("You are now in the Ops Room. Use: recon, scan, phish, brute, backdoor, exfiltrate, abort", "system");
    }

    function showStatus() {
      const p = game.player;
      log("Operator status:", "info");
      log("  Handle: " + (p.handle || "<unset>"), "system");
      log("  Role:   " + (p.role ? p.role.name : "<unset>"), "system");
      log(
        `  Level:  ${p.level} (${p.xp} XP) · Credits: ${p.credits}`,
        "system"
      );
      log(
        `  Stats:  Stealth ${p.stealth}, Tech ${p.tech}, Social ${p.social}`,
        "system"
      );
      log(`  Detection: ${p.detection}/100`, "system");

      if (game.currentMission) {
        log(
          `  Current mission: ${game.currentMission.name} (Diff ${game.currentMission.difficulty})`,
          "system"
        );
      }
    }

    function handleRoomCommand(args) {
      if (!args.length) {
        log("Usage: room <lobby|roles|missions|ops>", "error");
        return;
      }
      const room = args[0].toLowerCase();
      if (!["lobby", "roles", "missions", "ops"].includes(room)) {
        log("Unknown room. Valid: lobby, roles, missions, ops", "error");
        return;
      }
      setRoom(room);
      log("Moved to room: " + room, "system");
    }

    // ======== Mission action functions ========

    function checkInMission() {
      if (!game.inMission || !game.currentMission) {
        log("You are not currently in a mission. Use: mission <id>", "error");
        return false;
      }
      return true;
    }

    function doRecon() {
      if (!checkInMission()) return;
      const p = game.player;
      const m = game.currentMission;

      log("You perform high-level recon on the target...", "system");
      const baseChance = 70 + p.stealth * 3;
      const roll = randomBetween(1, 100);

      if (roll <= baseChance) {
        log("Recon successful. You map infrastructure and spot weak points.", "success");
        p.activeIntel.recon = true;
        p.adjustDetection(2);
        p.addXP(5 * m.difficulty);
      } else {
        log("Recon was noisy and gave little useful intel.", "error");
        p.adjustDetection(8);
      }
    }

    function doScan() {
      if (!checkInMission()) return;
      const p = game.player;
      const m = game.currentMission;

      log("Launching deeper technical scan...", "system");
      let baseChance = 60 + p.tech * 3;
      if (p.activeIntel.recon) baseChance += 10;

      const roll = randomBetween(1, 100);
      if (roll <= baseChance) {
        log("Scan successful. You identify misconfigurations.", "success");
        p.activeIntel.scan = true;
        p.adjustDetection(10);
        p.addXP(8 * m.difficulty);
      } else {
        log("Scan was noisy. Monitoring is on higher alert.", "error");
        p.adjustDetection(20);
      }
    }

    function doPhish() {
      if (!checkInMission()) return;
      const p = game.player;
      const m = game.currentMission;

      log("Crafting a realistic phishing attempt in the sim...", "system");
      let baseChance = 50 + p.social * 4;
      if (p.activeIntel.recon) baseChance += 5;

      const roll = randomBetween(1, 100);
      if (roll <= baseChance) {
        log(
          "A simulated user clicks your link and submits credentials in the training portal.",
          "success"
        );
        p.activeIntel.credentialEdge = true;
        p.adjustDetection(8);
        p.addXP(10 * m.difficulty);
      } else {
        log(
          "The simulated user reports your message. Security tightens slightly.",
          "error"
        );
        p.adjustDetection(15);
      }
    }

    function doBrute() {
      if (!checkInMission()) return;
      const p = game.player;
      const m = game.currentMission;

      log("You launch an aggressive brute-force style approach (simulated)...", "system");
      let baseChance = 40 + p.tech * 4;
      if (p.activeIntel.scan) baseChance += 10;
      if (p.activeIntel.credentialEdge) baseChance += 10;

      const roll = randomBetween(1, 100);
      if (roll <= baseChance) {
        log(
          "Your strategy finds a weak control that could be exploited in the sim.",
          "success"
        );
        p.activeIntel.backdoor = true;
        p.adjustDetection(20);
        p.addXP(12 * m.difficulty);
      } else {
        log("Defensive logs show clear attack patterns. Risk spikes.", "error");
        p.adjustDetection(30);
      }
    }

    function doBackdoor() {
      if (!checkInMission()) return;
      const p = game.player;
      const m = game.currentMission;

      log("Attempting to establish a persistent foothold (training only)...", "system");
      let baseChance = 45 + p.tech * 3 + p.stealth * 2;
      if (p.activeIntel.scan) baseChance += 10;
      if (p.activeIntel.credentialEdge) baseChance += 10;

      const roll = randomBetween(1, 100);
      if (roll <= baseChance) {
        log(
          "Backdoor established in the simulation. Future actions are a bit safer.",
          "success"
        );
        p.activeIntel.backdoor = true;
        p.adjustDetection(15);
        p.addXP(15 * m.difficulty);
      } else {
        log(
          "Persistence attempts are flagged in training logs. Monitoring tightens.",
          "error"
        );
        p.adjustDetection(25);
      }
    }

    function doExfiltrate() {
      if (!checkInMission()) return;
      const p = game.player;
      const m = game.currentMission;

      log("Attempting to complete objectives and exfiltrate simulated data...", "system");
      let baseChance = 30 + p.tech * 3 + p.stealth * 2;
      if (p.activeIntel.recon) baseChance += 5;
      if (p.activeIntel.scan) baseChance += 10;
      if (p.activeIntel.credentialEdge) baseChance += 10;
      if (p.activeIntel.backdoor) baseChance += 10;

      baseChance -= Math.floor(p.detection / 3);

      const roll = randomBetween(1, 100);
      log(`(Roll: ${roll}, need ≤ ${baseChance} to succeed)`, "system");

      if (roll <= baseChance) {
        const reward = m.baseReward + randomBetween(0, 30);
        log("MISSION SUCCESS: You complete the simulation objectives.", "success");
        log(`You earn ${reward} credits.`, "success");
        p.addCredits(reward);
        p.addXP(25 * m.difficulty);
        game.inMission = false;
        game.currentMission = null;
        p.resetMissionState();
        setRoom("missions");
      } else {
        log(
          "MISSION FAILED: Defenses detect irregular activity before completion.",
          "error"
        );
        p.adjustDetection(30);
        p.addXP(10 * m.difficulty);
        game.inMission = false;
        game.currentMission = null;
        p.resetMissionState();
        setRoom("missions");
      }
    }

    function doAbort() {
      if (!checkInMission()) return;
      const m = game.currentMission;
      log("You abort the mission and quietly disengage from the simulation.", "system");
      game.player.addXP(5 * m.difficulty);
      game.inMission = false;
      game.currentMission = null;
      game.player.resetMissionState();
      setRoom("missions");
    }

    // ============================= //
    //       COMMAND HANDLING        //
    // ============================= //

    function handleCommand(raw) {
      const trimmed = raw.trim();
      if (!trimmed) return;

      logCmd(trimmed);

      const parts = trimmed.split(/\s+/);
      const cmd = parts[0].toLowerCase();
      const args = parts.slice(1);

      if (cmd === "help") {
        showHelp(args[0]?.toLowerCase());
      } else if (cmd === "handle") {
        handleHandleCommand(args);
      } else if (cmd === "role") {
        handleRoleCommand(args);
      } else if (cmd === "missions") {
        listMissions();
      } else if (cmd === "mission") {
        startMission(args);
      } else if (cmd === "status") {
        showStatus();
      } else if (cmd === "room") {
        handleRoomCommand(args);
      } else if (["recon", "scan", "phish", "brute", "backdoor", "exfiltrate", "abort"].includes(cmd)) {
        // In-mission actions
        if (!requirePlayerSetup()) return;
        if (cmd === "recon") doRecon();
        if (cmd === "scan") doScan();
        if (cmd === "phish") doPhish();
        if (cmd === "brute") doBrute();
        if (cmd === "backdoor") doBackdoor();
        if (cmd === "exfiltrate") doExfiltrate();
        if (cmd === "abort") doAbort();
      } else {
        log("Unknown command. Try: help", "error");
      }

      if (game.player.detection >= 100) {
        log(
          "FULL DETECTION: The training environment locks you out of this run.",
          "error"
        );
        game.player.resetMissionState();
        game.inMission = false;
        game.currentMission = null;
        setRoom("lobby");
      }

      updateStatsRow();
    }

    // ============================= //
    //          BOOTSTRAP            //
    // ============================= //

    function init() {
      log("========================================", "system");
      log("        NetRunner Ops · Web Sim         ", "system");
      log("========================================", "system");
      log(
        "Welcome operator. This is a purely fictional cyber-ops training simulation.",
        "system"
      );
      log("Type `help` to see commands, or `help roles` to compare operator types.", "system");
      log("Getting started:", "info");
      log("  1) handle yourname", "system");
      log("  2) role 1   (or 2, 3)", "system");
      log("  3) missions", "system");
      log("  4) mission 1", "system");
      log("  5) recon / scan / phish / brute / backdoor / exfiltrate", "system");

      updateStatsRow();
      cmdInput.focus();
    }

    runBtn.addEventListener("click", () => {
      const value = cmdInput.value;
      cmdInput.value = "";
      handleCommand(value);
      cmdInput.focus();
    });

    cmdInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        runBtn.click();
      }
    });

    document.querySelectorAll(".room-card").forEach((card) => {
      card.addEventListener("click", () => {
        const room = card.getAttribute("data-room");
        handleCommand("room " + room);
      });
    });

    init();
  </script>
</body>
</html>